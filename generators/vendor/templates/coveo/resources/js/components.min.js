var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Coveo;!function(t){var e=function(){function e(){}return e.isInSalesforce=function(){return void 0!=window.sforce},e.isInSalesforceConsole=function(){return e.isInSalesforce()&&void 0!=window.sforce.console&&window.sforce.console.isInConsole()},e.focusOrOpenTab=function(t,e,n){void 0===n&&(n=!1),t="undefined"!=typeof t?t:"";var s=t;t=t.split("#")[0].split("?")[0];var i=this.getSfIdFromUrl(t),o=function(t,e){return!(!t||!e)&&t.indexOf(e,t.length-e.length)!==-1},a=function(e){return!e.success&&(h(c,t),!0)},r=0,l=!1,d=0,c=null,h=function(t,n){window.sforce.console.openSubtab(t,s,!0,e,null,function(t){t.success||window.open(s)})},u=function(e,n){if(!a(e)&&(d++,!l)){var s=$.parseJSON(e.pageInfo).url;s=s?s.split("#")[0].split("?")[0]:s;var u=$.parseJSON(e.pageInfo).objectId;u=u?u.substr(0,15):s,(u==i||o(t,s)||o(s,t))&&(window.sforce.console.focusSubtabById(n),l=!0),r--,l||0!=r||h(c,t)}},p=function(t){if(!a(t)){r=t.ids.length;for(var e=0;e<t.ids.length;e++)window.sforce.console.getPageInfo(t.ids[e],function(e){u(e,t.ids[d])})}},v=function(t){a(t)||(c=t.id,window.sforce.console.getSubtabIds(t.id,p))};n||window.sforce.console.getFocusedPrimaryTabId(v);var f=0,g=0,C=function(t){window.sforce.console.openPrimaryTab(null,s,!0,e,function(t){t.success||window.open(s)})},m=function(e,n){if(!a(e)&&(g++,!l)){var s=$.parseJSON(e.pageInfo).url;s=s?s.split("#")[0].split("?")[0]:s;var r=$.parseJSON(e.pageInfo).objectId;r=r?r.substr(0,15):s,(r==i||o(t,s)||o(s,t))&&(window.sforce.console.focusPrimaryTabById(n),l=!0),f--,l||0!=f||C(t)}},y=function(t){if(!a(t)){f=t.ids.length;for(var e=0;e<t.ids.length;e++)window.sforce.console.getPageInfo(t.ids[e],function(e){m(e,t.ids[g])})}};n&&window.sforce.console.getPrimaryTabIds(y)},e.getSfIdFromUrl=function(t){var e=t.substr(t.lastIndexOf("/")+1,18),n=/^\w+$/.test(e);return n?e.substr(0,15):t.split("#")[0].split("?")[0]},e.expandStringUsingRecord=function(t,n){if(null!=t){var s=t.match(/\{!(>?)(.*?)\}/g);if(null!=s)for(var i=0;i<s.length;i++){var o=s[i],a=/\{!(>?)(.*?)\}/g.exec(o),r=">"===a[1],l=a[2].toLowerCase(),d="";null!=n[l]&&(d=n[l].toString(),r&&(d=e.cleanSentenceForQuery(d))),t=t.replace(a[0],d)}}return t},e.expandStringUsingExpert=function(n,s){if(null!=n){var i=n.match(/%(\w+)%/g);if(null!=i)for(var o=0;o<i.length;o++){var a=i[o],r=/%(\w+)%/g.exec(a),l=r[1].toLowerCase(),d=t.Utils.getFieldValue(s,l);d=null!=d?e.cleanSentenceForQuery(d):"",n=n.replace(r[0],d)}}return n},e.cleanSentenceForQuery=function(t){return t.replace(/[\[\]"'\(\),\.@=<>:]/g,"")},e}();t.SalesforceUtilities=e}(Coveo||(Coveo={}));var Coveo;!function(t){var e=function(e){function n(s,i,o,a){e.call(this,s,t.ComponentOptions.initComponentOptions(s,n,i),o,a),this.element=s,this.options=i,this.result=a}return __extends(n,e),n.prototype.bindEventToOpen=function(){var n=this;if(t.SalesforceUtilities.isInSalesforceConsole()){var s=!1;return this.options.openInPrimaryTab?($(this.element).click(function(){t.SalesforceUtilities.focusOrOpenTab(decodeURIComponent(n.result.clickUri),n.result.title,!0)}),s=!0):this.options.openInSubTab&&($(this.element).click(function(){t.SalesforceUtilities.focusOrOpenTab(decodeURIComponent(n.result.clickUri),n.result.title,!1)}),s=!0),s||(s=e.prototype.bindEventToOpen.call(this)),s}return e.prototype.bindEventToOpen.call(this)},n.ID="SalesforceResultLink",n.options=_.extend({},{openInPrimaryTab:t.ComponentOptions.buildBooleanOption({defaultValue:!0}),openInSubTab:t.ComponentOptions.buildBooleanOption({defaultValue:!1})},t.ResultLink.options),n}(t.ResultLink);t.SalesforceResultLink=e,t.Initialization.registerAutoCreateComponent(e)}(Coveo||(Coveo={}));var Coveo;!function(t){var e=function(e){function n(s,i,o){var a=this;e.call(this,s,n.ID,o),this.element=s,this.options=i,this.bindings=o,this.options=t.ComponentOptions.initComponentOptions(s,n,i),$(this.root).on(t.AnalyticsEvents.changeAnalyticsCustomData,$.proxy(this.handleChangeAnalyticsEvents,this)),"undefined"!=typeof userActionsHandler&&this.setHandler(userActionsHandler),this.render(),this.options.enableBindOnBox&&$(s).closest(".CoveoBoxPopup").on("onPopupOpen",function(){a.open()})}return __extends(n,e),n.prototype.setHandler=function(t){this.handler=t},n.prototype.setFilters=function(t){this.options.filters=t},n.prototype.handleChangeAnalyticsEvents=function(e,s){s.actionType!=t.analyticsActionCauseList.getUserHistory.type&&s.actionType!=t.analyticsActionCauseList.userActionDocumentClick.type||(s.originLevel2=n.ID)},n.prototype.render=function(){var e=this;this.options.showButton&&this.renderButton().appendTo(this.element).click(function(){e.toggle()}),this.loadingBox=$(t.DomUtils.getBasicLoadingAnimation()).hide().appendTo(this.element),this.eventListBox=$("<div>").addClass("coveo-useractions-events-list").hide().appendTo(this.element)},n.prototype.open=function(){var e=this;this.eventListBox.is(":empty")&&null!=this.handler?(this.loadingBox.show(),this.usageAnalytics.logCustomEvent(t.analyticsActionCauseList.getUserHistory,null,this.element),this.handler.getDataFromUA(function(t){e.renderEvents(t)})):this.eventListBox.slideDown()},n.prototype.toggle=function(){this.eventListBox.is(":visible")?this.close():this.open()},n.prototype.close=function(){this.eventListBox.is(":visible")&&this.eventListBox.slideUp()},n.prototype.renderEvents=function(e){var n=this;this.eventListBox.empty(),null!=e.message?"NoVisitIdError"==e.type?(this.logger.info(e.message,e.type,e),$("<span>").text(t.l("UserActionsNoVisitId")).addClass("coveo-useractions-nodata").appendTo(this.eventListBox)):(this.logger.error(e.message,e.type,e),$("<span>").text(t.l("UserActionsErrorOccured")).addClass("coveo-useractions-nodata").appendTo(this.eventListBox)):e.totalNumberOfVisits>0?e.visits[0].numberOfEvents>0&&(this.renderHeaderBox(e.visits[0]).appendTo(this.eventListBox),_.each(e.visits[0].events,function(t){(_.contains(n.options.filters,t.eventMetadata.actionCause)||_.contains(n.options.filters,t.eventMetadata.customEventValue))&&n.renderEvent(t).appendTo(n.eventListBox)})):$("<span>").text(t.l("NoData")).addClass("coveo-useractions-nodata").appendTo(this.eventListBox),this.loadingBox.hide(),this.eventListBox.slideToggle()},n.prototype.renderEvent=function(e){var n=$("<div>").addClass("coveo-useractions-event"),s=$("<div>").addClass("coveo-useractions-event-right").appendTo(n),i=$("<div>").addClass("coveo-useractions-event-left").appendTo(n);return this.renderField(t.l("Time"),new Date(e.dateTime).toLocaleTimeString()).appendTo(i),e.eventMetadata.documentTitle&&e.eventMetadata.documentURL&&this.renderLinkField(t.l("Document"),e.eventMetadata.documentTitle,e.eventMetadata.documentURL).appendTo(s),e.eventMetadata.queryExpression&&this.renderField(t.l("UserQuery"),e.eventMetadata.queryExpression).appendTo(s),"pageView"==e.eventMetadata.customEventValue?this.renderLinkField(e.type,e.eventMetadata.originLevel3,e.eventMetadata.originLevel3).appendTo(s):e.eventMetadata.customEventValue&&this.renderField(e.type,e.eventMetadata.customEventValue).appendTo(s),s.is(":empty")&&this.renderField(t.l("EventType"),e.type+(e.eventMetadata.actionCause?", "+e.eventMetadata.actionCause:"")).appendTo(s),n},n.prototype.renderField=function(t,e){var n=$("<div>");return e&&($("<span>").addClass("coveo-useractions-event-title").text(t).appendTo(n),$("<span>").addClass("coveo-useractions-event-value-expand").text(e).appendTo(n)),n},n.prototype.renderLinkField=function(e,n,s){var i=this,o=$("<div>");return n&&($("<span>").addClass("coveo-useractions-event-title").text(e).appendTo(o),$("<a>").addClass("coveo-useractions-event-value-expand CoveoResultLink").text(n).attr("href",s).attr("target","_blanc").appendTo(o).click(function(){i.usageAnalytics.logCustomEvent(t.analyticsActionCauseList.userActionDocumentClick,{author:null,documentTitle:n,documentURL:s},i.element)})),o},n.prototype.renderHeaderBox=function(e){var n=$("<div>").addClass("coveo-useractions-event").addClass("coveo-useractions-event-header"),s=$("<div>").addClass("coveo-useractions-event-right").appendTo(n),i=$("<div>").addClass("coveo-useractions-event-left").appendTo(n),o=new Date(e.events[0].dateTime).toDateString(),a=new Date(e.events[0].dateTime).toLocaleTimeString(),r=t.DateUtils.timeBetween(new Date(e.events[0].dateTime),new Date(e.events[e.numberOfEvents-1].dateTime));return this.renderField(t.l("StartDate"),o).appendTo(i),this.renderField(t.l("StartTime"),a).css("float","left").appendTo(s),this.renderField(t.l("DurationTitle"),r).css("float","right").appendTo(s),n},n.prototype.renderButton=function(){return $("<div>").addClass("coveo-useractions-button").append($("<span>").text(t.l("ShowUserActions").toUpperCase()))},n.ID="UserActions",n.DEFAULT_FILTERS=["searchboxSubmit","documentOpen","documentQuickview","pageVisit","pageView","createCase"],n.options={showButton:t.ComponentOptions.buildBooleanOption({defaultValue:!1}),enableBindOnBox:t.ComponentOptions.buildBooleanOption({defaultValue:!0}),filters:t.ComponentOptions.buildListOption({defaultValue:n.DEFAULT_FILTERS})},n}(t.Component);t.UserActions=e,t.Initialization.registerAutoCreateComponent(e)}(Coveo||(Coveo={}));var Coveo;!function(t){var e=function(){function t(){}return t.enterOnSearchbox="enterOnSearchbox",t.quickviewLoaded="quickviewLoaded",t.openQuickview="openQuickview",t.attachToCase="attachToCase",t.detachFromCase="detachFromCase",t.attachToCaseStateChanged="attachToCaseStateChanged",t}();t.UserActionEvents=e}(Coveo||(Coveo={}));var Coveo;!function(t){var e=function(e){function n(s,i,o,a){e.call(this,s,n.ID),this.element=s,this.options=i,this.bindings=o,this.result=a,this.options=t.ComponentOptions.initComponentOptions(s,n,i),this.result=this.result||this.resolveResult(),this.searchInterface=this.searchInterface||this.resolveSearchInterface(),this.attached=!1,this.loading=!1,this.initialized=!1,"undefined"!=typeof attachToCaseEndpoint&&null!=attachToCaseEndpoint?this.setAttachToCaseEndpoint(attachToCaseEndpoint):this.logger.warn("No endpoint detected, make sure to set one using the SetAttachToCaseEndpoint method.")}return __extends(n,e),n.prototype.initialize=function(){var e=this;null!=this.attachToCaseEndpoint?this.attachToCaseEndpoint.data.succeeded?(this.handleData(this.attachToCaseEndpoint.data),$(this.root).on(t.UserActionEvents.attachToCaseStateChanged,function(t,n){return e.handleStateChanged(n)}),this.renderButton(),this.initialized=!0):this.logger.error("An error occured while getting attached results",attachToCaseEndpoint.data.message):this.logger.warn("No endpoint detected, make sure to set one using the SetAttachToCaseEndpoint method.")},n.prototype.attach=function(){var e=this;if(!this.isAttached()||!this.initialized||this.loading){this.loading=!0,this.updateButton();var n={resultUrl:this.result.clickUri,source:this.result.raw.source,title:t.StringAndHoles.shortenString(this.result.title,250,"...").value,name:t.StringAndHoles.shortenString(this.result.title,80,"...").value,uriHash:this.result.raw.urihash,knowledgeArticleId:this.result.raw.sfkbid,articleLanguage:this.result.raw.sflanguage,articleVersionNumber:this.result.raw.sfkbversionnumber,customs:{}},s={result:this.result,dataToAttach:n};$(this.root).trigger(t.UserActionEvents.attachToCase,s),this.logger.info("Attaching result to case",s),this.attachToCaseEndpoint.attachToCase(s.dataToAttach,function(t){return e.handleAttachCallback(t)})}},n.prototype.detach=function(){var e=this;if(!this.isAttached()&&this.initialized&&!this.loading)return!1;this.loading=!0,this.updateButton();var n={result:this.result};$(this.root).trigger(t.UserActionEvents.detachFromCase,n),this.logger.info("Detaching result from case",n),this.attachToCaseEndpoint.detachFromCase(this.result.raw.urihash,this.result.raw.sfkbid,function(t){return e.handleDetachCallback(t)})},n.prototype.setAttachToCaseEndpoint=function(t){null!=t&&(this.attachToCaseEndpoint=t,this.initialize())},n.prototype.isAttached=function(){return this.attached},n.prototype.handleClick=function(){this.isAttached()?this.detach():this.attach()},n.prototype.handleData=function(e){this.attachedResults=e.attachedResults,this.attached=_.contains(e.attachedResults,this.result.raw.urihash)||!t.Utils.isNullOrEmptyString(this.result.raw.sfkbid)&&_.contains(e.attachedResults,this.result.raw.sfkbid)},n.prototype.handleAttachCallback=function(e){if(null!=e)if(e.succeeded){this.attached=!0,this.attachedResults.push(this.result.raw.urihash),t.Utils.isNullOrEmptyString(this.result.raw.sfkbid)||this.attachedResults.push(this.result.raw.sfkbid);var n={articleID:this.result.raw.sfkbid,caseID:this.attachToCaseEndpoint.caseId,resultUriHash:this.result.raw.urihash,author:this.result.raw.author};this.usageAnalytics.logClickEvent(t.analyticsActionCauseList.caseAttach,{documentTitle:this.result.title,documentURL:this.result.clickUri,author:this.result.raw.author},this.result,this.root),this.usageAnalytics.logCustomEvent(t.analyticsActionCauseList.caseAttach,n,this.root)}else this.logger.error("Attach failed",e.message);this.loading=!1,this.updateButton()},n.prototype.handleDetachCallback=function(e){if(null!=e)if(e.succeeded){this.attached=!1,delete this.attachedResults[this.attachedResults.indexOf(this.result.raw.urihash)],t.Utils.isNullOrEmptyString(this.result.raw.sfkbid)||delete this.attachedResults[this.attachedResults.indexOf(this.result.raw.sfkbid)];var n={articleID:this.result.raw.sfkbid,caseID:this.attachToCaseEndpoint.caseId,resultUriHash:this.result.raw.urihash,author:this.result.raw.author};this.usageAnalytics.logCustomEvent(t.analyticsActionCauseList.caseDetach,n,this.root)}else this.logger.error("Detach failed",e.message);this.loading=!1,this.updateButton()},n.prototype.handleStateChanged=function(e){e.target!=this.element&&e.urihash==this.result.raw.urihash&&(this.attached=_.contains(this.attachedResults,this.result.raw.urihash)||!t.Utils.isNullOrEmptyString(this.result.raw.sfkbid)&&_.contains(this.attachedResults,this.result.raw.sfkbid),this.loading=e.loading,this.updateButton(!1))},n.prototype.renderButton=function(){var t=this;$(this.element).empty(),this.buttonElement=$(document.createElement("span")).appendTo(this.element),this.options.displayText&&(this.textElement=$(document.createElement("span")).appendTo(this.buttonElement)),this.options.readonly||($(this.element).click(function(){return t.handleClick()}),$(this.element).hover(function(){return t.handleHover(!0)},function(){return t.handleHover(!1)})),this.updateButton()},n.prototype.handleHover=function(e){this.isAttached()&&this.options.displayText&&this.textElement.text(e?t.l("Detach"):t.l("Attached"))},n.prototype.sendStateChangedEvent=function(){var e={target:this.element,urihash:this.result.raw.urihash,loading:this.loading};$(this.root).trigger(t.UserActionEvents.attachToCaseStateChanged,e)},n.prototype.updateButton=function(e){void 0===e&&(e=!0),this.buttonElement.removeClass(),this.loading?this.buttonElement.addClass("coveo-attach-to-case-loading"):this.isAttached()?this.buttonElement.addClass("coveo-attach-to-case-attached"):this.buttonElement.addClass("coveo-attach-to-case-attach"),this.options.readonly&&this.buttonElement.addClass("coveo-attach-to-case-readonly"),this.options.displayText&&this.textElement.text(this.isAttached()?t.l("Attached"):t.l("Attach")),e&&this.sendStateChangedEvent()},n.ID="AttachToCase",n.options={displayText:t.ComponentOptions.buildBooleanOption({defaultValue:!0}),readonly:t.ComponentOptions.buildBooleanOption({defaultValue:!1})},n}(t.Component);t.AttachToCase=e,t.Initialization.registerAutoCreateComponent(e)}(Coveo||(Coveo={}));var Coveo;!function(t){var e=function(e){function n(n,s,i){e.call(this,n,s,i),this.element=n,this.options=s,$(this.root).on(t.QueryEvents.buildingQuery,$.proxy(this.handleBuildingQueryForAttachedResults,this)),"undefined"!=typeof attachToCaseEndpoint&&null!=attachToCaseEndpoint&&this.setAttachToCaseEndpoint(attachToCaseEndpoint)}return __extends(n,e),n.prototype.setAttachToCaseEndpoint=function(t){null!=t&&(this.attachToCaseEndpoint=t)},n.prototype.handleBuildingQueryForAttachedResults=function(t,e){!this.disabled&&this.isSelected()&&null!=this.attachToCaseEndpoint&&this.attachToCaseEndpoint.data.succeeded&&(this.options.constant?e.queryBuilder.constantExpression.add(this.getExpressions()):e.queryBuilder.advancedExpression.add(this.getExpressions()))},n.prototype.getExpressions=function(){var e=new t.ExpressionBuilder,n=[],s=[];return this.attachToCaseEndpoint.data.attachedResults.forEach(function(t){0==t.indexOf("ka0")?n.push(t):s.push(t)}),s.length>0&&e.addFieldExpression("@urihash","=",s),n.length>0&&e.addFieldExpression("@sfkbid","=",n),n.length+s.length==0&&e.add("NOT @uri"),e.build(" OR ")},n.ID="AttachedResultsTab",n}(t.Tab);t.AttachedResultsTab=e,t.Initialization.registerAutoCreateComponent(e)}(Coveo||(Coveo={}));